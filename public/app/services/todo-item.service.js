(function(app) {

    app.TodoItemService =
    ng.core.Injectable().Class({
        constructor: function() {
            this.e_itemAdded = new ng.core.EventEmitter();
            this.e_itemsRetrieved = new ng.core.EventEmitter();

            this.todoItems = [];

            this.getTodoItems();
        },
        addTodoItem: function(item, cb) {
            var _this = this;
            var temp_id = item._id;

            // add the item to the list on the front-end
            this.todoItems.push(item);

            // alert components to the item being added to the front-end
            this.e_itemAdded.emit(item);

            // send the item to the server
            $.ajax({
                url: '/todos/',
                data: item,
                type: 'post',

                success: function(data, textStatus, xhr) {
                    // find the newly added item and assign it the ID generated by the server
                    _this.todoItems.forEach(function(_item, index) {
                        if (_item._id === temp_id)  _item._id = data._id;
                    });
                }
            });
        },
        getTodoItems: function(options, cb) {
            var _this = this;
            var data = [];

            $.ajax({
                url: '/todos/',
                data: {},
                type: 'get',

                success: function(data, textStatus, xhr) {
                    _this.todoItems = data;

                    // alert components to items being retrieved
                    _this.e_itemsRetrieved.emit();

                    if (typeof cb === 'function') cb(_this.todoItems);
                }
            });
        },
        updateItem: function(item, cb) {
            if (typeof cb !== 'function') cb = function() {};

            // send the updated item to the server
            $.ajax({
                url: '/todos/' + item._id,
                data: item,
                type: 'put',

                success: function(data, status, xhr) {
                    cb(null, item);
                },
                error: function(xhr, errorType, error) {
                    console.error(error);

                    cb(error);
                }
            });
        },
        removeItem: function(item, cb) {
            if (typeof cb !== 'function') cb = function() {};

            // go through the items and remove the one with the same ID is the given item
            this.todoItems = this.todoItems.filter(function(_item) {
                return _item._id !== item._id;
            });

            $.ajax({
                data: item,
                type: 'delete',
                url: '/todos/' + item._id,

                beforeSend: function() {
                    // if a temp ID is set, don't send to the server because it won't recognize it
                    if (item._id.indexOf('tmp_') !== -1) return false;
                },

                success: function(data, status, xhr) {
                    cb(null, item);
                },
                error: function(xhr, errorType, error) {
                    cb(error);
                }
            });
        }
    });

})(window.app || (window.app = {}));
